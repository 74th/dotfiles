#!/bin/python

import sys
import subprocess
import tempfile
from typing import Optional


def select_target(resource_type: Optional[str] = None):
    if resource_type:
        cmd = ["kubectl", "get", resource_type]
    else:
        cmd = ["kubectl", "get", "all"]
    with tempfile.NamedTemporaryFile(mode="wt") as fp:
        cmd_out = subprocess.run(cmd, check=True, capture_output=True, text=True)
        fp.write(cmd_out.stdout)
        fp.flush()
        peco_out = subprocess.run(
            ["peco", fp.name], check=True, text=True, capture_output=True
        )

    if peco_out.returncode != 0:
        return ""

    return peco_out.stdout.split(" ")[0]


def kubectl_describe(operation: str, target: list[str]):
    cmd = ["kubectl", operation] + target
    subprocess.run(cmd, check=True, text=True)


def main():
    if len(sys.argv) == 0:
        print("Usage: k- <operation> (<resource_type>)")
        sys.exit()
    if len(sys.argv) > 1:
        operation = sys.argv[1]
    if len(sys.argv) > 2:
        resource_type = sys.argv[2]
    else:
        resource_type = None
    target = select_target(resource_type)

    if not target:
        sys.exit(1)

    kubectl_describe(operation, [resource_type, target] if resource_type else [target])


if __name__ == "__main__":
    main()
