#!/usr/bin/python3
# ghq を使ってディレクトリを選んで code コマンドを実行
import sys
from typing import List, Optional
import invoke
from socket import gethostname

code = "code"
g = ""
if len(sys.argv) == 2:
    m = sys.argv[1]
    c = invoke.Context()
    l: List[str] = c.run("ghq list", hide=True).stdout.split("\n")
    for p in l:
        if p.find(m) >= 0:
            if len(g) == 0 or len(p) < len(g):
                g = p
else:
    c = invoke.Context()
    g = c.run("ghq list | peco").stdout.strip()

if not g:
    sys.exit(1)

g = c.run(f"ghq list --exact --full-path {g} | head -n1", hide=True).stdout.strip()
hostname = gethostname()
if hostname in ["violet-gopher"]:
    c.run(f"rcode {g}")
elif hostname in ["ciel"]:
    c.run(f"c {g}")
else:
    c.run(f"{code} {g}")
