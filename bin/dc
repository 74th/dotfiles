#!/usr/local/bin/system-python

import sys
import subprocess
import json
from pathlib import Path

# 参考: https://qiita.com/P-man_Brown/items/8ed6985f05cde494d16e

# 引数が指定されていればそのディレクトリを、なければ現在のディレクトリを使用
if len(sys.argv) > 1:
    project_dir = Path(sys.argv[1]).resolve()
else:
    project_dir = Path.cwd()

project_dir_basename = project_dir.name

# devcontainer.jsonからworkspaceFolderを取得
devcontainer_json_path = project_dir / ".devcontainer" / "devcontainer.json"
workspace_folder = f"/workspaces/{project_dir_basename}"

if devcontainer_json_path.exists():
    try:
        with open(devcontainer_json_path, "r", encoding="utf-8") as f:
            devcontainer_config = json.load(f)
            if "workspaceFolder" in devcontainer_config:
                workspace_folder = devcontainer_config["workspaceFolder"]
    except (json.JSONDecodeError, IOError) as e:
        print(f"Warning: Failed to read devcontainer.json: {e}", file=sys.stderr)

project_dir_hash = str(project_dir).encode("utf-8").hex()

folder_uri = f"vscode-remote://dev-container%2B{project_dir_hash}{workspace_folder}"

try:
    subprocess.run(["code", "--folder-uri", folder_uri], check=True, cwd=project_dir)
except subprocess.CalledProcessError as e:
    print(f"Error: Failed to open VS Code Dev Container: {e}", file=sys.stderr)
    sys.exit(1)
except FileNotFoundError:
    print(
        "Error: 'code' command not found. Please install VS Code CLI.",
        file=sys.stderr,
    )
    sys.exit(1)
